{"version":3,"sources":["documents.js","pip-webui-documents-html.js","document_list/document_list.js","document_list_edit/document_list_edit.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACdA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxJA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"pip-webui-documents.js","sourcesContent":["/**\r\n * @file Registration of WebUI documents controls\r\n * @copyright Digital Living Software Corp. 2014-2016\r\n */\r\n\r\n(function (angular) {\r\n    'use strict';\r\n\r\n    angular.module('pipDocuments', [\r\n        'pipDocumentList',\r\n        'pipDocumentListEdit'\r\n    ]);\r\n\r\n})(window.angular);\r\n","(function(module) {\ntry {\n  module = angular.module('pipDocuments.Templates');\n} catch (e) {\n  module = angular.module('pipDocuments.Templates', []);\n}\nmodule.run(['$templateCache', function($templateCache) {\n  $templateCache.put('document_list/document_list.html',\n    '<!--\\n' +\n    '@file Document list control content\\n' +\n    '@copyright Digital Living Software Corp. 2014-2016\\n' +\n    '-->\\n' +\n    '\\n' +\n    '<md-button class=\"pip-documents-name\"\\n' +\n    '           ng-class=\"{\\'lp24-flex rp16\\': pipDocumentIcon}\"\\n' +\n    '           ng-click=\"onTitleClick($event); onResize()\"\\n' +\n    '           aria-label=\"RESIZE\">\\n' +\n    '\\n' +\n    '    <div class=\"layout-align-start-center layout-row w-stretch\">\\n' +\n    '        <md-icon md-svg-icon=\"icons:document\" ng-class=\"{\\'pip-icon\\': pipDocumentIcon}\" ng-if=\"pipDocumentIcon\"></md-icon>\\n' +\n    '        <span class=\"pip-documents-text\">\\n' +\n    '            {{documents.length}} {{::\\'DOCUMENTS_ATTACHED\\' | translate}}\\n' +\n    '        </span>\\n' +\n    '\\n' +\n    '        <md-icon class=\"icon-up\" md-svg-icon=\"icons:triangle-up\"></md-icon>\\n' +\n    '        <md-icon class=\"icon-down\" md-svg-icon=\"icons:triangle-down\"></md-icon>\\n' +\n    '    </div>\\n' +\n    '</md-button>\\n' +\n    '<div pip-focused class=\"pip-documents-container bm8\"  ng-class=\"{\\'lp24-flex rp24-flex\\': pipDocumentIcon}\">\\n' +\n    '    <md-button class=\"pip-document-download md-primary\"\\n' +\n    '               ng-class=\"{\\'pip-focusable\\' : !ngDisabled()}\"\\n' +\n    '               href=\"{{::documentUrl(document)}}\"\\n' +\n    '               target=\"_blank\"\\n' +\n    '               ng-disabled=\"ngDisabled() || document.error\"\\n' +\n    '               ng-repeat=\"document in documents track by document.file_id\"\\n' +\n    '               aria-label=\"DOCUMENT\">\\n' +\n    '\\n' +\n    '        <div class=\"pip-default-icon\">\\n' +\n    '            <md-icon md-svg-icon=\"icons:{{::documentList.icon}}\"></md-icon>\\n' +\n    '        </div>\\n' +\n    '        <div class=\"pip-document-title\">\\n' +\n    '            {{::document.file_name}}\\n' +\n    '        </div>\\n' +\n    '    </md-button>\\n' +\n    '</div>');\n}]);\n})();\n\n(function(module) {\ntry {\n  module = angular.module('pipDocuments.Templates');\n} catch (e) {\n  module = angular.module('pipDocuments.Templates', []);\n}\nmodule.run(['$templateCache', function($templateCache) {\n  $templateCache.put('document_list/document_list_collapse.html',\n    '<!--\\n' +\n    '@file Document list control content (collapsable version)\\n' +\n    '@copyright Digital Living Software Corp. 2014-2016\\n' +\n    '-->\\n' +\n    '\\n' +\n    '<div class=\"pip-documents-name\" ng-click=\"onTitleClick($event); onResize()\">\\n' +\n    '    <span class=\"pip-documents-text\">\\n' +\n    '        {{documents.length}} {{::\\'DOCUMENTS_ATTACHED\\' | translate}}\\n' +\n    '    </span>\\n' +\n    '\\n' +\n    '    <md-icon class=\"icon-up\" md-svg-icon=\"icons:triangle-up\"></md-icon>\\n' +\n    '    <md-icon class=\"icon-down\" md-svg-icon=\"icons:triangle-down\"></md-icon>\\n' +\n    '</div>\\n' +\n    '<div pip-focused class=\"pip-documents-container bm8\">\\n' +\n    '    <md-button class=\"pip-document-download pip-focusable md-primary\"\\n' +\n    '               href=\"{{::document.url}}\"\\n' +\n    '               target=\"_blank\"\\n' +\n    '               ng-repeat=\"document in documents track by document.file_id\"\\n' +\n    '               aria-label=\"DOCUMENT\">\\n' +\n    '        <div class=\"pip-default-icon\">\\n' +\n    '            <md-icon md-svg-icon=\"icons:{{::icon}}\"></md-icon>\\n' +\n    '        </div>\\n' +\n    '        <div class=\"pip-document-title\">\\n' +\n    '            {{::document.file_name}}\\n' +\n    '        </div>\\n' +\n    '    </md-button>\\n' +\n    '</div>\\n' +\n    '');\n}]);\n})();\n\n(function(module) {\ntry {\n  module = angular.module('pipDocuments.Templates');\n} catch (e) {\n  module = angular.module('pipDocuments.Templates', []);\n}\nmodule.run(['$templateCache', function($templateCache) {\n  $templateCache.put('document_list_edit/document_list_edit.html',\n    '<!--\\n' +\n    '@file Document list edit control content\\n' +\n    '@copyright Digital Living Software Corp. 2014-2016\\n' +\n    '-->\\n' +\n    '<div pip-focusable>\\n' +\n    '\t<div class=\"pip-document-upload pointer md-primary \"\\n' +\n    '\t\t ng-class=\"{\\'pip-focusable\\' : !ngDisabled(), \\'pip-item-error\\' : item.state == \\'error\\'}\"\\n' +\n    '\t\t ng-keydown=\"onKeyDown($event, item)\"\\n' +\n    '\t\t tabindex=\"{{ ngDisabled() ? -1 : 0 }}\"\\n' +\n    '\t\t ng-repeat=\"item in control.items | filter: filterItem\">\\n' +\n    '\\n' +\n    '\t\t<div class=\"pip-default-icon\"\\n' +\n    '\t\t\t ng-class=\"{ \\'pip-document-new\\': item.id == null }\">\\n' +\n    '\t\t\t<md-icon pip-cancel-drag=\"true\" class=\"md-primary\" ng-if=\"item.state == \\'original\\' || item.state == \\'added\\'\"\\n' +\n    '\t\t\t\t\t md-svg-icon=\"icons:{{::documentList.icon}}\">\\n' +\n    '\t\t\t</md-icon>\\n' +\n    '\t\t\t<md-icon pip-cancel-drag=\"true\" class=\"md-warn\" ng-if=\"item.state == \\'error\\'\"\\n' +\n    '\t\t\t\t\t md-svg-icon=\"icons:{{::documentList.iconError}}\">\\n' +\n    '\t\t\t</md-icon>\\n' +\n    '\t\t</div>\\n' +\n    '\\n' +\n    '\t\t<div class=\"pip-document-title\" pip-cancel-drag=\"true\">\\n' +\n    '\t\t\t{{::item.name}}\\n' +\n    '\t\t</div>\\n' +\n    '\t\t<md-button ng-click=\"onDelete(item)\"\\n' +\n    '\t\t\t\t   ng-disabled=\"ngDisabled() || control.uploading\"\\n' +\n    '\t\t\t\t   tabindex=\"-1\"\\n' +\n    '\t\t\t\t   ng-hide=\"ngDisabled()\"\\n' +\n    '\t\t\t\t   class=\"md-icon-button\" aria-label=\"DELETE\">\\n' +\n    '\\n' +\n    '\t\t\t<md-icon md-svg-icon=\"icons:cross\" pip-cancel-drag=\"true\"></md-icon>\\n' +\n    '\t\t</md-button>\\n' +\n    '\t\t<md-progress-linear ng-show=\"item.uploading\" ng-value=\"item.progress\"></md-progress-linear>\\n' +\n    '\t</div>\\n' +\n    '\t\\n' +\n    '\t<button class=\"pip-document-upload pip-document-drop \"\\n' +\n    '\t\t\tng-class=\"{\\'pip-focusable\\' : !ngDisabled()}\"\\n' +\n    '\t\t\tng-keydown=\"onKeyDown($event)\" tabindex=\"0\"\\n' +\n    '\t\t\tng-file-drop ng-file-select ng-file-change=\"onSelect($files)\"\\n' +\n    '\t\t\tng-multiple=\"true\"\\n' +\n    '\t\t\tng-disabled=\"ngDisabled() || control.uploading\"\\n' +\n    '\t\t\taria-label=\"UPLOAD\">\\n' +\n    '\\n' +\n    '\t\t<div class=\"pip-default-icon\">\\n' +\n    '\t\t\t<md-icon pip-cancel-drag=\"true\" md-svg-icon=\"icons:{{::documentList.icon}}\"></md-icon>\\n' +\n    '\t\t</div>\\n' +\n    '\t\t<div class=\"pip-default-text\">\\n' +\n    '\t\t\t<span>\\n' +\n    '\t\t\t\t{{documentList.text | translate}}\\n' +\n    '\t\t\t</span>\\n' +\n    '\t\t</div>\\n' +\n    '\t</button>\\n' +\n    '\t<div class=\"clearfix\"></div>\\n' +\n    '</div>\\n' +\n    '');\n}]);\n})();\n","/**\r\n * @file Document list control\r\n * @copyright Digital Living Software Corp. 2014-2016\r\n * @todo\r\n * - Improve samples in sampler app\r\n */\r\n\r\n(function (angular, _) {\r\n    'use strict';\r\n\r\n    var thisModule = angular.module('pipDocumentList', ['pipCore', 'pipRest', 'pipFocused', 'pipDocuments.Templates']);\r\n\r\n    thisModule.config(['pipTranslateProvider', function (pipTranslateProvider) {\r\n        pipTranslateProvider.translations('en', {\r\n            DOCUMENTS_ATTACHED: 'document(s) attached',\r\n            ERROR_DOCUMENTS_LOADED: 'Error: <%= error_number %> document(s) are not loaded'\r\n        });\r\n        pipTranslateProvider.translations('ru', {\r\n            DOCUMENTS_ATTACHED: 'документов добавлено',\r\n            ERROR_DOCUMENTS_LOADED: 'Ошибка: <%= error_number %> документ(ов) не загружено'\r\n        });\r\n    }]);\r\n\r\n    thisModule.directive('pipDocumentList',\r\n        ['$parse', '$rootScope', 'pipUtils', 'pipRest', 'pipToasts', 'pipTranslate', function ($parse, $rootScope, pipUtils, pipRest, pipToasts, pipTranslate) {  // eslint-disable-line no-unused-vars\r\n            return {\r\n                restrict: 'EA',\r\n                scope: true,\r\n                templateUrl: 'document_list/document_list.html',\r\n                link: function ($scope, $element, $attrs) {\r\n                    var documentsGetter = $parse($attrs.pipDocuments),\r\n                        $documentsContainer = $element.children('.pip-documents-container'),\r\n                        $up = $element.find('.icon-up'),\r\n                        $down = $element.find('.icon-down'),\r\n                        collapsable = pipUtils.toBoolean($attrs.pipCollapse);\r\n\r\n                    $scope.documentList = {};\r\n                    $scope.documentList.icon = 'document';\r\n                    $scope.documents = documentsGetter($scope);\r\n\r\n                    if ($attrs.pipDocumentIcon) {\r\n                        $scope.pipDocumentIcon = true;\r\n                    }\r\n\r\n                    $scope.showDocuments = collapsable;\r\n\r\n                    if (!collapsable) {\r\n                        $up.hide();\r\n                        $documentsContainer.hide();\r\n                    } else {\r\n                        $down.hide();\r\n                    }\r\n\r\n                    if ($attrs.disabled) {\r\n                        $up.hide();\r\n                        $down.hide();\r\n                    }\r\n\r\n                    // Also optimization to avoid watch if it is unnecessary\r\n                    if (pipUtils.toBoolean($attrs.pipRebind)) {\r\n                        $scope.$watch(documentsGetter, function (newValue) {\r\n                            if (differentDocumentList(newValue)) {\r\n                                $scope.documents = newValue;\r\n                            }\r\n                        });\r\n                    }\r\n\r\n                    $scope.onTitleClick = onTitleClick;\r\n                    $scope.documentUrl = documentUrl;\r\n\r\n                    // Add class\r\n                    $element.addClass('pip-document-list');\r\n\r\n                    function differentDocumentList(newList) {\r\n                        var i, obj;\r\n\r\n                        if (!$scope.documents && newList) { return true; }\r\n                        if ($scope.documents && !newList) { return true; }\r\n                        if ($scope.documents.length !== newList.length) { return true; }\r\n\r\n                        for (i = 0; i < newList.length; i++) {\r\n                            obj = _.find($scope.documents, {file_id: newList[i].file_id});\r\n\r\n                            if (obj === undefined) { return true; }\r\n                        }\r\n\r\n                        return false;\r\n                    }\r\n\r\n                    function onTitleClick(event) {\r\n                        if (event) { event.stopPropagation(); }\r\n\r\n                        if ($attrs.disabled) { return; }\r\n\r\n                        $scope.showDocuments = !$scope.showDocuments;\r\n                        $up[$scope.showDocuments ? 'show' : 'hide']();\r\n                        $down[!$scope.showDocuments ? 'show' : 'hide']();\r\n                        $documentsContainer[$scope.showDocuments ? 'show' : 'hide']();\r\n                    }\r\n\r\n                    function documentUrl(document) {\r\n                        var\r\n                            serverUrl = pipRest.serverUrl(),\r\n                            userId = ($rootScope.$user || {}).id,\r\n                            partyId = ($rootScope.$party || {}).id || userId;\r\n\r\n                        return serverUrl + '/api/parties/' + partyId + '/files/' + document.file_id + '/content';\r\n                    }\r\n                }\r\n            };\r\n        }]\r\n    );\r\n\r\n})(window.angular, window._);\r\n\r\n","/**\r\n * @file Document list edit control\r\n * @copyright Digital Living Software Corp. 2014-2016\r\n * @todo\r\n * - Improve samples in sampler app\r\n * - Add add/remove/hover animations\r\n */\r\n\r\n(function (angular, _) {\r\n    'use strict';\r\n\r\n    var thisModule = angular.module('pipDocumentListEdit',\r\n        ['ui.event', 'angularFileUpload', 'pipCore', 'pipFocused', 'pipRest', 'pipDocuments.Templates']);\r\n\r\n    thisModule.config(['pipTranslateProvider', function (pipTranslateProvider) {\r\n        pipTranslateProvider.translations('en', {\r\n            DOCUMENT_LIST_EDIT_TEXT: 'Click here to add a document',\r\n            ERROR_TRANSACTION_IN_PROGRESS: 'Transaction is in progress. Please, wait until it\\'s finished or abort'\r\n        });\r\n        pipTranslateProvider.translations('ru', {\r\n            DOCUMENT_LIST_EDIT_TEXT: 'Нажмите сюда, чтобы добавить документ',\r\n            ERROR_TRANSACTION_IN_PROGRESS: 'Транзакция еще не завершена. Подождите окончания или прервите её'\r\n        });\r\n    }]);\r\n\r\n    thisModule.directive('pipDocumentListEdit',\r\n        function () {\r\n            return {\r\n                restrict: 'EA',\r\n                scope: {\r\n                    pipDocuments: '=',\r\n                    pipAddedDocument: '=',\r\n                    ngDisabled: '&',\r\n                    pipCreated: '&',\r\n                    pipChanged: '&'\r\n                },\r\n                templateUrl: 'document_list_edit/document_list_edit.html',\r\n                controller: 'pipDocumentListEditController'\r\n            };\r\n        }\r\n    );\r\n\r\n    thisModule.controller('pipDocumentListEditController',\r\n        ['$scope', '$rootScope', '$element', '$attrs', '$parse', '$http', '$upload', '$timeout', 'pipRest', 'pipUtils', function ($scope, $rootScope, $element, $attrs, $parse, $http, $upload, $timeout, pipRest, pipUtils) {\r\n            var\r\n                $control = $element.children('.pip-picture-drop'),\r\n                itemPin = 0;\r\n\r\n            $scope.documentList = {};\r\n            $scope.documentList.text = $attrs.pipDefaultText || 'DOCUMENT_LIST_EDIT_TEXT';\r\n            $scope.documentList.icon = $attrs.pipDefaultIcon || 'document';\r\n            $scope.documentList.iconError = 'warn-circle';\r\n            $scope.documentStartState = pipUtils.toBoolean($scope.pipAddedDocument) ? 'copied' : 'original';\r\n            $scope.cancelDrag = pipUtils.toBoolean($attrs.pipCanselDrag) === true;\r\n\r\n            $scope.control = {\r\n                uploading: 0,\r\n                items: getItems(),\r\n                reset: resetDocument,\r\n                save: saveDocument,\r\n                abort: onAbort\r\n            };\r\n\r\n            $scope.filterItem = filterItem;\r\n            $scope.onDelete = onDelete;\r\n            $scope.onKeyDown = onKeyDown;\r\n            $scope.onChange = onChange;\r\n            $scope.onSelect = onSelect;\r\n\r\n            // Add class\r\n            $element.addClass('pip-document-list-edit');\r\n\r\n            // Initialize control\r\n            $scope.control.reset();\r\n\r\n            executeCallback();\r\n\r\n            // Watch for changes\r\n            $scope.$watchCollection(\r\n                function () {\r\n                    // Todo: Optimize change tracking\r\n                    return $scope.pipDocuments;\r\n                },\r\n                function (newValue) {\r\n                    if (!_.isEqual(newValue, $scope.pipDocuments)) {\r\n                        $scope.control.reset();\r\n                    }\r\n                }\r\n            );\r\n\r\n            function getItems() {\r\n                var\r\n                    documents = $scope.pipDocuments,\r\n                    items = [],\r\n                    i;\r\n\r\n                if (documents === null || documents.length === 0) {\r\n                    return items;\r\n                }\r\n\r\n                for (i = 0; i < documents.length; i++) {\r\n                    items.push({\r\n                        pin: itemPin++,\r\n                        id: documents[i].file_id,\r\n                        name: documents[i].file_name,\r\n                        uploading: false,\r\n                        uploaded: false,\r\n                        progress: 0,\r\n                        file: null,\r\n                        state: $scope.documentStartState // 'original'\r\n                    });\r\n                }\r\n\r\n                return items;\r\n            }\r\n\r\n            function setItems() {\r\n                var item, i;\r\n\r\n                // Clean the array\r\n                if ($scope.pipDocuments && $scope.pipDocuments.length > 0) {\r\n                    $scope.pipDocuments.splice(0, $scope.pipDocuments.length);\r\n                }\r\n\r\n                for (i = 0; i < $scope.control.items.length; i++) {\r\n                    item = $scope.control.items[i];\r\n\r\n                    if (item.id) {\r\n                        $scope.pipDocuments.push({\r\n                            file_id: item.id,\r\n                            file_name: item.name\r\n                        });\r\n                    }\r\n                }\r\n            }\r\n\r\n            function resetDocument() {\r\n                $scope.control.uploading = 0;\r\n                $scope.control.items = getItems();\r\n            }\r\n\r\n            function getItemIdUrl(item) {\r\n                var\r\n                    serverUrl = pipRest.serverUrl(),\r\n                    partyId = $rootScope.$party ? $rootScope.$party.id : pipRest.userId();\r\n\r\n                return serverUrl + '/api/parties/' + partyId + '/files/' + item.id;\r\n            }\r\n\r\n            function addItemUrl(item) {\r\n                var\r\n                    serverUrl = pipRest.serverUrl(),\r\n                    partyId = $rootScope.$party ? $rootScope.$party.id : pipRest.userId();\r\n\r\n                return serverUrl + '/api/parties/' + partyId + '/files?name=' + item.file.name;\r\n            }\r\n\r\n            function addItem(item, callback) {\r\n                var\r\n                    file = item.file,\r\n                    fileReader = new FileReader();\r\n\r\n                // Avoid double transactions\r\n                if (item.uploading || item.file === null || item.state !== 'added') { return; }\r\n\r\n                fileReader.onload = function (e) {\r\n                    if (item.uploading) { return; }\r\n\r\n                    item.uploading = true;\r\n\r\n                    item.upload = $upload.http({\r\n                        url: addItemUrl(item),\r\n                        headers: { 'Content-Type': file.type },\r\n                        data: e.target.result\r\n                    })\r\n                    .then(\r\n                        function (response) {\r\n                            item.id = response.data.id;\r\n                            item.name = response.data.filename || item.name;\r\n                            item.uploaded = true;\r\n                            item.uploading = false;\r\n                            item.progress = 0;\r\n                            item.upload = null;\r\n                            item.file = null;\r\n                            item.state = 'original';\r\n                            callback();\r\n                        },\r\n                        function () {\r\n                            item.uploaded = false;\r\n                            item.uploading = false;\r\n                            item.progress = 0;\r\n                            item.upload = null;\r\n                            item.state = 'error';\r\n                            callback();\r\n                        },\r\n                        function (e) {\r\n                            // Math.min is to fix IE which reports 200% sometimes\r\n                            item.progress = Math.min(100, parseInt(100.0 * e.loaded / e.total));\r\n                        }\r\n                    );\r\n                };\r\n\r\n                fileReader.readAsArrayBuffer(file);\r\n            }\r\n\r\n            function deleteItem(item, callback) {\r\n                var control = $scope.control;\r\n\r\n                // Avoid double transactions\r\n                if (item.upload) {\r\n                    item.upload.abort();\r\n                    item.upload = null;\r\n                }\r\n\r\n                if (item.state !== 'deleted') { return; }\r\n\r\n                $http['delete'](getItemIdUrl(item))\r\n                .success(function () {\r\n                    _.remove(control.items, {pin: item.pin});\r\n                    callback();\r\n                })\r\n                .error(function (data) {\r\n                    // Todo: perform a better processing\r\n                    if (data == null) {\r\n                        _.remove(control.items, {pin: item.pin});\r\n                    } else {\r\n                        item.uploaded = false;\r\n                        item.uploading = false;\r\n                        item.progress = 0;\r\n                        item.upload = null;\r\n                    }\r\n\r\n                    callback(data);\r\n                });\r\n            }\r\n\r\n            function saveDocument(successCallback, errorCallback) {\r\n                var control = $scope.control,\r\n                    onItemCallback,\r\n                    item,\r\n                    i;\r\n\r\n                if (control.uploading) {\r\n                    if (errorCallback) {\r\n                        errorCallback('ERROR_TRANSACTION_IN_PROGRESS');\r\n                    }\r\n\r\n                    return;\r\n                }\r\n\r\n                control.error = null;\r\n                control.uploading = 0;\r\n\r\n                onItemCallback = function (error) {\r\n                    // Storing only the first error\r\n                    if (error && !control.error) {\r\n                        control.error = error;\r\n                    }\r\n\r\n                    control.uploading--;\r\n\r\n                    // Finished uploading\r\n                    if (control.uploading == 0) {\r\n                        if (control.error) {\r\n                            if (errorCallback) {\r\n                                errorCallback(control.error);\r\n                            } else {\r\n                                console.error(control.error);   // eslint-disable-line no-console\r\n                            }\r\n                        } else {\r\n                            setItems();\r\n                            if (successCallback) {\r\n                                successCallback();\r\n                            }\r\n                        }\r\n                    }\r\n                };\r\n\r\n                for (i = 0; i < control.items.length; i++) {\r\n                    item = control.items[i];\r\n\r\n                    if (item.state === 'added') {\r\n                        control.uploading++;\r\n                        addItem(item, onItemCallback);\r\n                    } else if (item.state === 'deleted') {\r\n                        control.uploading++;\r\n                        deleteItem(item, onItemCallback);\r\n                    }\r\n                }\r\n\r\n                // Nothing was uploaded\r\n                if (control.uploading == 0) {\r\n                    if (successCallback) {\r\n                        successCallback();\r\n                    }\r\n                }\r\n            }\r\n\r\n            function onAbort() {\r\n                var control = $scope.control,\r\n                    item,\r\n                    i;\r\n\r\n                for (i = 0; i < control.items.length; i++) {\r\n                    item = control.items[i];\r\n\r\n                    if (item.uploading) {\r\n                        if (item.upload) {\r\n                            item.upload.abort();\r\n                        }\r\n\r\n                        item.uploaded = false;\r\n                        item.uploading = false;\r\n                        item.progress = 0;\r\n                        item.upload = null;\r\n                    }\r\n                }\r\n\r\n                // Abort transaction\r\n                control.uploading = 0;\r\n            }\r\n\r\n            // Visualization functions\r\n\r\n            function filterItem(item) {\r\n                return item.state !== 'deleted';\r\n            }\r\n\r\n            // Process user actions\r\n            function onSelect($files) {\r\n                var file,\r\n                    i;\r\n\r\n                $control.focus();\r\n\r\n                if ($files == null || $files.length === 0) { return; }\r\n\r\n                for (i = 0; i < $files.length; i++) {\r\n                    file = $files[i];\r\n\r\n                    $scope.control.items.push({\r\n                        pin: itemPin++,\r\n                        id: null,\r\n                        name: file.name,\r\n                        uploading: false,\r\n                        uploaded: false,\r\n                        progress: 0,\r\n                        file: file,\r\n                        state: 'added'\r\n                    });\r\n                }\r\n\r\n                $scope.onChange();\r\n            }\r\n\r\n            function onDelete(item) {\r\n                if (item.state === 'added' || item.state === 'copied') {\r\n                    _.remove($scope.control.items, {pin: item.pin});\r\n                } else {\r\n                    item.state = 'deleted';\r\n                }\r\n\r\n                $scope.onChange();\r\n            }\r\n\r\n            function onKeyDown($event, item) {\r\n                if (item) {\r\n                    if ($event.keyCode === 46 || $event.keyCode === 8) {\r\n                        if (item.state === 'added') {\r\n                            _.remove($scope.control.items, { pin: item.pin });\r\n                        } else {\r\n                            item.state = 'deleted';\r\n                        }\r\n\r\n                        $scope.onChange();\r\n                    }\r\n                } else if ($event.keyCode === 13 || $event.keyCode === 32) {\r\n                    // !! Avoid clash with $apply()\r\n                    setTimeout(function () {\r\n                        $control.trigger('click');\r\n                    }, 0);\r\n                }\r\n            }\r\n\r\n            // On change event\r\n            function onChange() {\r\n                if ($scope.pipChanged) {\r\n                    $scope.pipChanged({\r\n                        $event: { sender: $scope.control },\r\n                        $control: $scope.control\r\n                    });\r\n                }\r\n            }\r\n\r\n            function executeCallback() {\r\n                // Execute callback\r\n                if ($scope.pipCreated) {\r\n                    $scope.pipCreated({\r\n                        $event: { sender: $scope.control },\r\n                        $control: $scope.control\r\n                    });\r\n                }\r\n            }\r\n\r\n        }]\r\n    );\r\n\r\n})(window.angular, window._);\r\n\r\n"],"sourceRoot":"/source/"}