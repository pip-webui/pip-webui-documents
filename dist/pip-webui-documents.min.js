!function(){"use strict";angular.module("pipDocuments",["pipDocumentList","pipDocumentListEdit"])}(),function(e){try{e=angular.module("pipDocuments.Templates")}catch(n){e=angular.module("pipDocuments.Templates",[])}e.run(["$templateCache",function(e){e.put("document_list/document_list.html",'<md-button class="pip-documents-name" ng-class="{\'lp24-flex rp16\': pipDocumentIcon}" ng-click="onTitleClick($event); onResize()" aria-label="RESIZE"><div class="layout-align-start-center layout-row w-stretch"><md-icon md-svg-icon="icons:document" ng-class="{\'pip-icon\': pipDocumentIcon}" ng-if="pipDocumentIcon"></md-icon><span class="pip-documents-text">{{documents.length}} {{::\'DOCUMENTS_ATTACHED\' | translate}}</span><md-icon class="icon-up" md-svg-icon="icons:triangle-up"></md-icon><md-icon class="icon-down" md-svg-icon="icons:triangle-down"></md-icon></div></md-button><div pip-focused="" class="pip-documents-container bm8" ng-class="{\'lp24-flex rp24-flex\': pipDocumentIcon}"><md-button class="pip-document-download md-primary" ng-class="{\'pip-focusable\' : !ngDisabled()}" href="{{::documentUrl(document)}}" target="_blank" ng-disabled="ngDisabled() || document.error" ng-repeat="document in documents track by document.file_id" aria-label="DOCUMENT"><div class="pip-default-icon"><md-icon md-svg-icon="icons:{{::documentList.icon}}"></md-icon></div><div class="pip-document-title">{{::document.file_name}}</div></md-button></div>')}])}(),function(e){try{e=angular.module("pipDocuments.Templates")}catch(n){e=angular.module("pipDocuments.Templates",[])}e.run(["$templateCache",function(e){e.put("document_list/document_list_collapse.html",'<div class="pip-documents-name" ng-click="onTitleClick($event); onResize()"><span class="pip-documents-text">{{documents.length}} {{::\'DOCUMENTS_ATTACHED\' | translate}}</span><md-icon class="icon-up" md-svg-icon="icons:triangle-up"></md-icon><md-icon class="icon-down" md-svg-icon="icons:triangle-down"></md-icon></div><div pip-focused="" class="pip-documents-container bm8"><md-button class="pip-document-download pip-focusable md-primary" href="{{::document.url}}" target="_blank" ng-repeat="document in documents track by document.file_id" aria-label="DOCUMENT"><div class="pip-default-icon"><md-icon md-svg-icon="icons:{{::icon}}"></md-icon></div><div class="pip-document-title">{{::document.file_name}}</div></md-button></div>')}])}(),function(e){try{e=angular.module("pipDocuments.Templates")}catch(n){e=angular.module("pipDocuments.Templates",[])}e.run(["$templateCache",function(e){e.put("document_list_edit/document_list_edit.html",'<div pip-focusable=""><div class="pip-document-upload pointer md-primary" ng-class="{\'pip-focusable\' : !ngDisabled(), \'pip-item-error\' : item.state == \'error\'}" ng-keydown="onKeyDown($event, item)" tabindex="{{ ngDisabled() ? -1 : 0 }}" ng-repeat="item in control.items | filter: filterItem"><div class="pip-default-icon" ng-class="{ \'pip-document-new\': item.id == null }"><md-icon pip-cancel-drag="true" class="md-primary" ng-if="item.state == \'original\' || item.state == \'added\'" md-svg-icon="icons:{{::documentList.icon}}"></md-icon><md-icon pip-cancel-drag="true" class="md-warn" ng-if="item.state == \'error\'" md-svg-icon="icons:{{::documentList.iconError}}"></md-icon></div><div class="pip-document-title" pip-cancel-drag="true">{{::item.name}}</div><md-button ng-click="onDelete(item)" ng-disabled="ngDisabled() || control.uploading" tabindex="-1" ng-hide="ngDisabled()" class="md-icon-button" aria-label="DELETE"><md-icon md-svg-icon="icons:cross" pip-cancel-drag="true"></md-icon></md-button><md-progress-linear ng-show="item.uploading" ng-value="item.progress"></md-progress-linear></div><button class="pip-document-upload pip-document-drop" ng-class="{\'pip-focusable\' : !ngDisabled()}" ng-keydown="onKeyDown($event)" tabindex="0" ng-file-drop="" ng-file-select="" ng-file-change="onSelect($files)" ng-multiple="true" ng-disabled="ngDisabled() || control.uploading" aria-label="UPLOAD"><div class="pip-default-icon"><md-icon pip-cancel-drag="true" md-svg-icon="icons:{{::documentList.icon}}"></md-icon></div><div class="pip-default-text"><span>{{documentList.text | translate}}</span></div></button><div class="clearfix"></div></div>')}])}(),function(){"use strict";var e=angular.module("pipDocumentList",["pipCore","pipRest","pipFocused","pipDocuments.Templates"]);e.config(["pipTranslateProvider",function(e){e.translations("en",{DOCUMENTS_ATTACHED:"document(s) attached",ERROR_DOCUMENTS_LOADED:"Error: <%= error_number %> document(s) are not loaded"}),e.translations("ru",{DOCUMENTS_ATTACHED:"документов добавлено",ERROR_DOCUMENTS_LOADED:"Ошибка: <%= error_number %> документ(ов) не загружено"})}]),e.directive("pipDocumentList",["$parse","$rootScope","pipUtils","pipRest","$http","pipToasts","pipTranslate",function(e,n,t,i,o,a,d){return{restrict:"EA",scope:!0,templateUrl:"document_list/document_list.html",link:function(o,a,d){function c(e){if(!o.documents&&e)return!0;if(o.documents&&!e)return!0;if(o.documents.length!=e.length)return!0;for(var n=0;n<e.length;n++){var t=_.find(o.documents,{file_id:e[n].file_id});if(void 0===t)return!0}return!1}function l(e){e&&e.stopPropagation(),d.disabled||(o.showDocuments=!o.showDocuments,u[o.showDocuments?"show":"hide"](),m[o.showDocuments?"hide":"show"](),p[o.showDocuments?"show":"hide"]())}function s(e){var t=i.serverUrl(),o=(n.$user||{}).id,a=(n.$party||{}).id||o;return t+"/api/parties/"+a+"/files/"+e.file_id+"/content"}var r=e(d.pipDocuments),p=a.children(".pip-documents-container"),u=a.find(".icon-up"),m=a.find(".icon-down"),g=t.toBoolean(d.pipCollapse);o.documentList={},o.documentList.icon="document",o.documents=r(o),d.pipDocumentIcon&&(o.pipDocumentIcon=!0),o.showDocuments=g,g?m.hide():(u.hide(),p.hide()),d.disabled&&(u.hide(),m.hide()),t.toBoolean(d.pipRebind)&&o.$watch(r,function(e){c(e)&&(o.documents=e)}),o.onTitleClick=l,o.documentUrl=s,a.addClass("pip-document-list")}}}])}(),function(){"use strict";var e=angular.module("pipDocumentListEdit",["ui.event","angularFileUpload","pipCore","pipFocused","pipRest","pipDocuments.Templates"]);e.config(["pipTranslateProvider",function(e){e.translations("en",{DOCUMENT_LIST_EDIT_TEXT:"Click here to add a document",ERROR_TRANSACTION_IN_PROGRESS:"Transaction is in progress. Please, wait until it's finished or abort"}),e.translations("ru",{DOCUMENT_LIST_EDIT_TEXT:"Нажмите сюда, чтобы добавить документ",ERROR_TRANSACTION_IN_PROGRESS:"Транзакция еще не завершена. Подождите окончания или прервите её"})}]),e.directive("pipDocumentListEdit",function(){return{restrict:"EA",scope:{pipDocuments:"=",pipAddedDocument:"=",ngDisabled:"&",pipCreated:"&",pipChanged:"&"},templateUrl:"document_list_edit/document_list_edit.html",controller:"pipDocumentListEditController"}}),e.controller("pipDocumentListEditController",["$scope","$rootScope","$element","$attrs","$parse","$http","$upload","$timeout","pipRest","pipUtils",function(e,n,t,i,o,a,d,c,l,s){function r(){var n=e.pipDocuments,t=[];if(null==n||0==n.length)return t;for(var i=0;i<n.length;i++)t.push({pin:y++,id:n[i].file_id,name:n[i].file_name,uploading:!1,uploaded:!1,progress:0,file:null,state:e.documentStartState});return t}function p(){e.pipDocuments&&e.pipDocuments.length>0&&e.pipDocuments.splice(0,e.pipDocuments.length);for(var n=0;n<e.control.items.length;n++){var t=e.control.items[n];t.id&&e.pipDocuments.push({file_id:t.id,file_name:t.name})}}function u(){e.control.uploading=0,e.control.items=r()}function m(e){var t=l.serverUrl(),i=n.$party?n.$party.id:l.userId();return t+"/api/parties/"+i+"/files/"+e.id}function g(e){var t=l.serverUrl(),i=n.$party?n.$party.id:l.userId();return t+"/api/parties/"+i+"/files?name="+e.file.name}function f(n,t){var i=(e.control,n.file);if(!n.uploading&&null!=n.file&&"added"==n.state){var o=new FileReader;o.onload=function(e){n.uploading||(n.uploading=!0,n.upload=d.http({url:g(n),headers:{"Content-Type":i.type},data:e.target.result}).then(function(e){n.id=e.data.id,n.name=e.data.filename||n.name,n.uploaded=!0,n.uploading=!1,n.progress=0,n.upload=null,n.file=null,n.state="original",t()},function(e){n.uploaded=!1,n.uploading=!1,n.progress=0,n.upload=null,n.state="error",t()},function(e){n.progress=Math.min(100,parseInt(100*e.loaded/e.total))}))},o.readAsArrayBuffer(i)}}function v(n,t){var i=e.control;n.upload&&(n.upload.abort(),n.upload=null),"deleted"==n.state&&a["delete"](m(n)).success(function(e){_.remove(i.items,{pin:n.pin}),t()}).error(function(e,o){null==e?_.remove(i.items,{pin:n.pin}):(n.uploaded=!1,n.uploading=!1,n.progress=0,n.upload=null),t(e)})}function D(n,t){var i=e.control;if(i.uploading)return void(t&&t("ERROR_TRANSACTION_IN_PROGRESS"));i.error=null,i.uploading=0;for(var o=function(e){e&&!i.error&&(i.error=e),i.uploading--,0==i.uploading&&(i.error?t?t(i.error):console.error(i.error):(p(),n&&n()))},a=0;a<i.items.length;a++){var d=i.items[a];"added"==d.state?(i.uploading++,f(d,o)):"deleted"==d.state&&(i.uploading++,v(d,o))}0==i.uploading&&n&&n()}function h(){for(var n=e.control,t=0;t<n.items.length;t++){var i=n.items[t];i.uploading&&(i.upload&&i.upload.abort(),i.uploaded=!1,i.uploading=!1,i.progress=0,i.upload=null)}n.uploading=0}function T(e){return"deleted"!=e.state}function b(n){if($.focus(),null!=n&&0!=n.length){for(var t=0;t<n.length;t++){var i=n[t];e.control.items.push({pin:y++,id:null,name:i.name,uploading:!1,uploaded:!1,progress:0,file:i,state:"added"})}e.onChange()}}function C(n){"added"==n.state||"copied"==n.state?_.remove(e.control.items,{pin:n.pin}):n.state="deleted",e.onChange()}function E(n,t){t?46!=n.keyCode&&8!=n.keyCode||("added"==t.state?_.remove(e.control.items,{pin:t.pin}):t.state="deleted",e.onChange()):13!=n.keyCode&&32!=n.keyCode||setTimeout(function(){$.trigger("click")},0)}function R(){e.pipChanged&&e.pipChanged({$event:{sender:e.control},$control:e.control})}function w(){e.pipCreated&&e.pipCreated({$event:{sender:e.control},$control:e.control})}var $=t.children(".pip-picture-drop");e.documentList={},e.documentList.text=i.pipDefaultText||"DOCUMENT_LIST_EDIT_TEXT",e.documentList.icon=i.pipDefaultIcon||"document",e.documentList.iconError="warn-circle",e.documentStartState=s.toBoolean(e.pipAddedDocument)?"copied":"original",e.cancelDrag=s.toBoolean(i.pipCanselDrag)===!0;var y=0;e.control={uploading:0,items:r(),reset:u,save:D,abort:h},e.filterItem=T,e.onDelete=C,e.onKeyDown=E,e.onChange=R,e.onSelect=b,t.addClass("pip-document-list-edit"),e.control.reset(),w(),e.$watchCollection(function(){return e.pipDocuments},function(n){_.isEqual(n,e.pipDocuments)||e.control.reset()})}])}();